{% extends "base.html" %}

{% block title %}Admin Panel - CloudShare{% endblock %}
{% block container_width %}min(1200px, 100%){% endblock %}
{% block header_margin %}40px{% endblock %}
{% block logo_size %}36px{% endblock %}
{% block tagline %}Panel Admin{% endblock %}

{% block extra_css %}
/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 40px;
    animation: fadeInUp 0.6s ease 0.1s backwards;
}

.stat-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.stat-card:hover {
    background: rgba(255,255,255,0.06);
    transform: translateY(-3px);
    border-color: rgba(102,126,234,0.3);
}

.stat-icon { font-size: 32px; margin-bottom: 12px; }
.stat-value {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 6px;
}
.stat-label {
    font-size: 12px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Chart */
.chart-section {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 40px;
    animation: fadeInUp 0.6s ease 0.2s backwards;
}
.chart-title {
    font-size: 14px;
    font-weight: 600;
    color: rgba(255,255,255,0.6);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 20px;
}
.chart-bars {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    height: 100px;
}
.chart-bar-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    height: 100%;
    justify-content: flex-end;
}
.chart-bar {
    width: 100%;
    background: linear-gradient(180deg, #667eea, #764ba2);
    border-radius: 4px 4px 0 0;
    min-height: 4px;
    transition: all 0.5s ease;
    opacity: 0.8;
}
.chart-bar:hover { opacity: 1; transform: scaleY(1.05); transform-origin: bottom; }
.chart-date {
    font-size: 9px;
    color: rgba(255,255,255,0.3);
    text-align: center;
    white-space: nowrap;
}

/* Toolbar */
.toolbar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    animation: fadeInUp 0.6s ease 0.3s backwards;
}
.search-input {
    flex: 1;
    min-width: 200px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    padding: 12px 20px;
    font-size: 14px;
    color: #fff;
    border-radius: 50px;
    font-family: 'Space Grotesk', sans-serif;
    transition: all 0.3s ease;
}
.search-input:focus {
    outline: none;
    border-color: rgba(102,126,234,0.5);
    background: rgba(255,255,255,0.05);
}
.search-input::placeholder { color: rgba(255,255,255,0.3); }
.filter-select {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    padding: 12px 20px;
    font-size: 14px;
    color: rgba(255,255,255,0.7);
    border-radius: 50px;
    font-family: 'Space Grotesk', sans-serif;
    cursor: pointer;
}
.filter-select option { background: #1a1a2e; color: #fff; }

/* Table */
.table-section {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    overflow: hidden;
    animation: fadeInUp 0.6s ease 0.4s backwards;
}
.table-header-row {
    display: grid;
    grid-template-columns: 60px 1fr 100px 80px 90px 80px 130px;
    padding: 14px 20px;
    background: rgba(255,255,255,0.04);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    font-size: 11px;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
}
.file-row {
    display: grid;
    grid-template-columns: 60px 1fr 100px 80px 90px 80px 130px;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    align-items: center;
    transition: background 0.2s ease;
    font-size: 14px;
}
.file-row:last-child { border-bottom: none; }
.file-row:hover { background: rgba(255,255,255,0.03); }

.file-thumb {
    width: 42px;
    height: 42px;
    border-radius: 8px;
    object-fit: cover;
    background: rgba(102,126,234,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}
.file-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}
.file-name {
    font-weight: 500;
    color: rgba(255,255,255,0.9);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 12px;
}
.file-name small {
    display: block;
    font-size: 11px;
    color: rgba(255,255,255,0.3);
    font-weight: 400;
    margin-top: 2px;
}
.badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}
.badge-video { background: rgba(102,126,234,0.2); color: #667eea; }
.badge-image { background: rgba(16,185,129,0.2); color: #10b981; }
.badge-locked { background: rgba(245,158,11,0.2); color: #f59e0b; }
.badge-blocked { background: rgba(239,68,68,0.2); color: #ef4444; }
.badge-public { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.4); }

.file-size { color: rgba(255,255,255,0.5); font-size: 13px; }
.file-date { color: rgba(255,255,255,0.4); font-size: 12px; }

/* Action Buttons */
.action-btns { display: flex; gap: 6px; }
.action-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}
.btn-view { background: rgba(102,126,234,0.15); color: #667eea; }
.btn-edit { background: rgba(16,185,129,0.15); color: #10b981; }
.btn-block { background: rgba(245,158,11,0.15); color: #f59e0b; }
.btn-delete { background: rgba(239,68,68,0.15); color: #ef4444; }
.action-btn:hover { transform: scale(1.15); opacity: 0.9; }

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal {
    background: #0f0f1a;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 36px;
    width: 90%;
    max-width: 480px;
    animation: fadeInUp 0.3s ease;
}
.modal-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 24px;
    color: #fff;
}
.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 28px;
    justify-content: flex-end;
}
.btn-sm {
    padding: 10px 24px;
    font-size: 14px;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 600;
    transition: all 0.2s ease;
}
.btn-sm-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
.btn-sm-danger { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
.btn-sm-cancel { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.6); }
.btn-sm:hover { transform: translateY(-2px); opacity: 0.9; }

.empty-state {
    padding: 60px 20px;
    text-align: center;
    color: rgba(255,255,255,0.3);
}
.empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }

/* Logout link */
.admin-logout {
    font-size: 12px;
    color: rgba(255,255,255,0.3);
    text-decoration: none;
    margin-left: auto;
    padding: 8px 16px;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 50px;
    transition: all 0.2s;
}
.admin-logout:hover { color: #ef4444; border-color: rgba(239,68,68,0.3); }

@media (max-width: 900px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .table-header-row, .file-row {
        grid-template-columns: 42px 1fr 70px 80px 120px;
    }
    .col-size, .col-status { display: none; }
}
@media (max-width: 600px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .col-size, .col-status, .col-type { display: none; }
    .table-section { overflow-x: auto; }
    .table-header-row, .file-row {
        grid-template-columns: 42px 1fr 80px 120px;
        min-width: unset;
    }
    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    .search-input, .filter-select { width: 100%; }
    .chart-bars { gap: 4px; }
    .chart-date { font-size: 8px; }
    .stat-value { font-size: 22px; }
    .stat-icon { font-size: 26px; }
    .action-btn { width: 30px; height: 30px; font-size: 13px; }
}
{% endblock %}

{% block content %}
<!-- Admin Header Bar -->
<div style="display:flex; align-items:center; margin-bottom:32px; gap:12px; animation: fadeInUp 0.5s ease;">
    <div style="font-size:13px; color:rgba(255,255,255,0.4); text-transform:uppercase; letter-spacing:1.5px;">Panel Admin</div>
    <div style="height:1px; flex:1; background:rgba(255,255,255,0.08);"></div>
    <a href="/{{ admin_token }}/logout" class="admin-logout">Keluar</a>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üìÅ</div>
        <div class="stat-value" id="statTotal">{{ stats.total }}</div>
        <div class="stat-label">Total File</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üíæ</div>
        <div class="stat-value" id="statStorage">{{ stats.storage }}</div>
        <div class="stat-label">Storage Terpakai</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üé¨</div>
        <div class="stat-value" id="statVideos">{{ stats.videos }}</div>
        <div class="stat-label">Video</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üîí</div>
        <div class="stat-value" id="statLocked">{{ stats.locked }}</div>
        <div class="stat-label">Terproteksi</div>
    </div>
</div>

<!-- Upload Chart -->
<div class="chart-section">
    <div class="chart-title">Upload 14 Hari Terakhir</div>
    <div class="chart-bars" id="chartBars">
        {% for day in chart_data %}
        <div class="chart-bar-wrap">
            <div class="chart-bar" style="height: {{ day.pct }}%" title="{{ day.count }} file"></div>
            <div class="chart-date">{{ day.label }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Upload Section -->
<div id="uploadSection" style="margin-bottom:32px; animation: fadeInUp 0.6s ease 0.25s backwards;">
    <div style="font-size:13px; color:rgba(255,255,255,0.4); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:16px;">Upload File Baru</div>
    <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:24px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
            <div>
                <label class="label">Judul</label>
                <input type="text" id="upTitle" class="input-field" placeholder="Judul file" maxlength="100" style="padding:12px 16px;">
            </div>
            <div>
                <label class="label">Kata Sandi (opsional)</label>
                <input type="password" id="upPassword" class="input-field" placeholder="Kosongkan = publik" maxlength="50" style="padding:12px 16px;">
            </div>
        </div>
        <div style="margin-bottom:16px;">
            <label class="label">Deskripsi (opsional)</label>
            <input type="text" id="upDescription" class="input-field" placeholder="Tambahkan deskripsi..." maxlength="500" style="padding:12px 16px;">
        </div>
        <div id="upDropZone" style="border:2px dashed rgba(255,255,255,0.15); border-radius:12px; padding:32px; text-align:center; cursor:pointer; transition:all 0.3s ease;" onclick="document.getElementById('upFileInput').click()">
            <div style="font-size:32px; margin-bottom:8px;">‚ö°</div>
            <div style="color:rgba(255,255,255,0.6); font-size:14px; margin-bottom:4px;">Klik atau drag file di sini</div>
            <div style="color:rgba(255,255,255,0.3); font-size:12px;">Gambar & Video ‚Ä¢ Maks 100MB</div>
            <input type="file" id="upFileInput" style="display:none" accept="image/*,video/*">
        </div>
        <div id="upProgress" style="display:none; margin-top:12px;">
            <div style="background:rgba(255,255,255,0.05); border-radius:50px; height:6px; overflow:hidden;">
                <div id="upProgressBar" style="height:100%; background:linear-gradient(90deg,#667eea,#764ba2); width:0%; transition:width 0.3s ease; border-radius:50px;"></div>
            </div>
            <div id="upProgressText" style="font-size:12px; color:rgba(255,255,255,0.4); margin-top:6px; text-align:center;">Mengupload...</div>
        </div>
        <div id="upError" style="display:none; color:#ef4444; font-size:13px; margin-top:10px; padding:10px 16px; background:rgba(239,68,68,0.1); border-radius:8px;"></div>
    </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
    <input type="text" class="search-input" id="searchInput" placeholder="üîç  Cari file..." oninput="filterFiles()">
    <select class="filter-select" id="filterType" onchange="filterFiles()">
        <option value="all">Semua Tipe</option>
        <option value="video">Video</option>
        <option value="image">Gambar</option>
    </select>
    <select class="filter-select" id="filterStatus" onchange="filterFiles()">
        <option value="all">Semua Status</option>
        <option value="locked">Terkunci</option>
        <option value="blocked">Diblokir</option>
        <option value="public">Publik</option>
    </select>
</div>

<!-- Table -->
<div class="table-section">
    <div class="table-header-row">
        <div></div>
        <div>File</div>
        <div class="col-type">Tipe</div>
        <div class="col-size">Ukuran</div>
        <div class="col-status">Status</div>
        <div>Tanggal</div>
        <div>Aksi</div>
    </div>
    <div id="fileTableBody">
        {% if files %}
            {% for file_id, f in files %}
            <div class="file-row"
                data-id="{{ file_id }}"
                data-type="{{ f.resource_type }}"
                data-title="{{ f.title|lower }}"
                data-status="{{ 'blocked' if f.blocked else ('locked' if f.password else 'public') }}">

                <!-- Thumbnail -->
                <div class="file-thumb">
                    {% if f.resource_type == 'image' %}
                        <img src="{{ f.cloudinary_url }}" alt="" loading="lazy" onerror="this.parentElement.innerHTML='üñºÔ∏è'">
                    {% else %}
                        üé¨
                    {% endif %}
                </div>

                <!-- Name -->
                <div class="file-name">
                    {{ f.title }}
                    <small>{{ f.original_filename }}</small>
                </div>

                <!-- Type -->
                <div class="col-type">
                    <span class="badge {{ 'badge-video' if f.resource_type == 'video' else 'badge-image' }}">
                        {{ f.resource_type }}
                    </span>
                </div>

                <!-- Size -->
                <div class="file-size col-size">
                    {{ "%.1f"|format(f.bytes / 1024 / 1024) }} MB
                </div>

                <!-- Status -->
                <div class="col-status">
                    {% if f.blocked %}
                        <span class="badge badge-blocked">Diblokir</span>
                    {% elif f.password %}
                        <span class="badge badge-locked">üîí Kunci</span>
                    {% else %}
                        <span class="badge badge-public">Publik</span>
                    {% endif %}
                </div>

                <!-- Date -->
                <div class="file-date">
                    {{ f.uploaded_at[:10] if f.uploaded_at else '-' }}
                </div>

                <!-- Actions -->
                <div class="action-btns">
                    <button class="action-btn btn-view" onclick="viewFile('{{ file_id }}')" title="Lihat">üëÅÔ∏è</button>
                    <button class="action-btn btn-edit" onclick="editFile('{{ file_id }}', '{{ f.title|replace("'","\\'")|replace('"','\\"') }}', '{{ f.description or '' }}', '{{ f.password or '' }}')" title="Edit">‚úèÔ∏è</button>
                    <button class="action-btn btn-block" onclick="toggleBlock('{{ file_id }}', {{ 'true' if f.blocked else 'false' }})" title="{{ 'Buka Blokir' if f.blocked else 'Blokir' }}">{{ 'üîì' if f.blocked else 'üö´' }}</button>
                    <button class="action-btn btn-delete" onclick="confirmDelete('{{ file_id }}', '{{ f.title|replace("'","\\'")|replace('"','\\"') }}')" title="Hapus">üóëÔ∏è</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <div>Belum ada file yang diupload</div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal Edit -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-title">‚úèÔ∏è Edit File</div>
        <input type="hidden" id="editFileId">
        <div class="form-group">
            <label class="label">Judul</label>
            <input type="text" id="editTitle" class="input-field" maxlength="100">
        </div>
        <div class="form-group">
            <label class="label">Deskripsi</label>
            <textarea id="editDescription" class="input-field" maxlength="500"></textarea>
        </div>
        <div class="form-group">
            <label class="label">Kata Sandi (kosongkan untuk hapus)</label>
            <input type="text" id="editPassword" class="input-field" placeholder="Kosongkan = publik">
        </div>
        <div class="modal-actions">
            <button class="btn-sm btn-sm-cancel" onclick="closeModal('editModal')">Batal</button>
            <button class="btn-sm btn-sm-primary" onclick="saveEdit()">Simpan</button>
        </div>
    </div>
</div>

<!-- Modal Delete -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <div class="modal-title">üóëÔ∏è Hapus File</div>
        <input type="hidden" id="deleteFileId">
        <p style="color:rgba(255,255,255,0.6); margin-bottom:8px;">Yakin ingin menghapus file ini?</p>
        <p style="color:rgba(239,68,68,0.8); font-size:14px;" id="deleteFileName"></p>
        <p style="color:rgba(255,255,255,0.4); font-size:13px; margin-top:12px;">File akan dihapus dari Cloudinary dan database secara permanen.</p>
        <div class="modal-actions">
            <button class="btn-sm btn-sm-cancel" onclick="closeModal('deleteModal')">Batal</button>
            <button class="btn-sm btn-sm-danger" onclick="deleteFile()">Hapus Permanen</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" style="
    position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px);
    background:rgba(15,15,26,0.95); border:1px solid rgba(102,126,234,0.4);
    padding:14px 28px; border-radius:50px; font-size:14px; color:#fff;
    transition:transform 0.3s ease; z-index:9999; pointer-events:none;
    backdrop-filter:blur(10px);
"></div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const ADMIN_TOKEN = "{{ admin_token }}";

    function showToast(msg, color='#667eea') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.borderColor = color + '66';
        t.style.transform = 'translateX(-50%) translateY(0)';
        setTimeout(() => t.style.transform = 'translateX(-50%) translateY(100px)', 2500);
    }

    function viewFile(fileId) {
        window.open('/' + fileId, '_blank');
    }

    function editFile(fileId, title, description, password) {
        document.getElementById('editFileId').value = fileId;
        document.getElementById('editTitle').value = title;
        document.getElementById('editDescription').value = description;
        document.getElementById('editPassword').value = password;
        document.getElementById('editModal').classList.add('active');
    }

    function confirmDelete(fileId, title) {
        document.getElementById('deleteFileId').value = fileId;
        document.getElementById('deleteFileName').textContent = '"' + title + '"';
        document.getElementById('deleteModal').classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    async function saveEdit() {
        const fileId = document.getElementById('editFileId').value;
        const title = document.getElementById('editTitle').value.trim();
        const description = document.getElementById('editDescription').value.trim();
        const password = document.getElementById('editPassword').value.trim();

        const res = await fetch('/admin-api/edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file_id: fileId, title, description, password, token: ADMIN_TOKEN })
        });
        const data = await res.json();

        if (data.success) {
            showToast('‚úÖ File berhasil diupdate');
            closeModal('editModal');
            setTimeout(() => location.reload(), 800);
        } else {
            showToast('‚ùå ' + data.error, '#ef4444');
        }
    }

    async function deleteFile() {
        const fileId = document.getElementById('deleteFileId').value;
        const res = await fetch('/admin-api/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file_id: fileId, token: ADMIN_TOKEN })
        });
        const data = await res.json();

        if (data.success) {
            showToast('üóëÔ∏è File dihapus');
            closeModal('deleteModal');
            const row = document.querySelector(`.file-row[data-id="${fileId}"]`);
            if (row) row.remove();
        } else {
            showToast('‚ùå ' + data.error, '#ef4444');
        }
    }

    async function toggleBlock(fileId, isBlocked) {
        const res = await fetch('/admin-api/block', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ file_id: fileId, blocked: !isBlocked, token: ADMIN_TOKEN })
        });
        const data = await res.json();

        if (data.success) {
            showToast(isBlocked ? 'üîì Blokir diangkat' : 'üö´ File diblokir');
            setTimeout(() => location.reload(), 800);
        } else {
            showToast('‚ùå ' + data.error, '#ef4444');
        }
    }

    function filterFiles() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const type = document.getElementById('filterType').value;
        const status = document.getElementById('filterStatus').value;
        const rows = document.querySelectorAll('.file-row');

        rows.forEach(row => {
            const matchSearch = row.dataset.title.includes(search);
            const matchType = type === 'all' || row.dataset.type === type;
            const matchStatus = status === 'all' || row.dataset.status === status;
            row.style.display = (matchSearch && matchType && matchStatus) ? '' : 'none';
        });
    }


    // ===== UPLOAD =====
    const upFileInput = document.getElementById('upFileInput');
    const upDropZone = document.getElementById('upDropZone');

    upDropZone.addEventListener('dragover', e => { e.preventDefault(); upDropZone.style.borderColor='#667eea'; });
    upDropZone.addEventListener('dragleave', () => { upDropZone.style.borderColor='rgba(255,255,255,0.15)'; });
    upDropZone.addEventListener('drop', e => {
        e.preventDefault();
        upDropZone.style.borderColor='rgba(255,255,255,0.15)';
        if (e.dataTransfer.files.length > 0) handleUpload(e.dataTransfer.files[0]);
    });
    upFileInput.addEventListener('change', e => {
        if (e.target.files.length > 0) handleUpload(e.target.files[0]);
    });

    async function handleUpload(file) {
        const maxSize = 100 * 1024 * 1024;
        if (file.size > maxSize) { showUpError('File terlalu besar. Maksimal 100MB.'); return; }
        const validTypes = ['image/', 'video/'];
        if (!validTypes.some(t => file.type.startsWith(t))) { showUpError('Tipe file tidak valid.'); return; }

        document.getElementById('upError').style.display = 'none';
        document.getElementById('upProgress').style.display = 'block';
        setProgress(0, 'Meminta signature...');

        try {
            // Step 1: Get signature
            const signRes = await fetch('/sign-upload', { method: 'POST' });
            const signData = await signRes.json();
            if (!signData.success) throw new Error(signData.error);

            setProgress(10, 'Mengupload ke Cloudinary...');

            // Step 2: Upload to Cloudinary with XHR for progress
            const formData = new FormData();
            formData.append('file', file);
            formData.append('public_id', signData.public_id);
            formData.append('timestamp', signData.timestamp);
            formData.append('api_key', signData.api_key);
            formData.append('signature', signData.signature);

            const uploadResult = await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${signData.cloud_name}/auto/upload`);
                xhr.upload.onprogress = e => {
                    if (e.lengthComputable) {
                        const pct = Math.round(10 + (e.loaded / e.total) * 80);
                        setProgress(pct, `Mengupload... ${pct}%`);
                    }
                };
                xhr.onload = () => {
                    const res = JSON.parse(xhr.responseText);
                    if (res.error) reject(new Error(res.error.message));
                    else resolve(res);
                };
                xhr.onerror = () => reject(new Error('Upload gagal'));
                xhr.send(formData);
            });

            setProgress(95, 'Menyimpan data...');

            // Step 3: Save metadata
            const title = document.getElementById('upTitle').value.trim();
            const description = document.getElementById('upDescription').value.trim();
            const password = document.getElementById('upPassword').value.trim();

            const saveRes = await fetch('/save-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    file_id: signData.file_id,
                    secure_url: uploadResult.secure_url,
                    public_id: uploadResult.public_id,
                    format: uploadResult.format,
                    resource_type: uploadResult.resource_type,
                    bytes: uploadResult.bytes,
                    original_filename: file.name,
                    width: uploadResult.width,
                    height: uploadResult.height,
                    duration: uploadResult.duration,
                    title, description, password,
                })
            });
            const saveData = await saveRes.json();
            if (!saveData.success) throw new Error(saveData.error);

            setProgress(100, 'Selesai!');
            showToast('‚úÖ Upload berhasil!');
            document.getElementById('upTitle').value = '';
            document.getElementById('upDescription').value = '';
            document.getElementById('upPassword').value = '';
            upFileInput.value = '';
            setTimeout(() => {
                document.getElementById('upProgress').style.display = 'none';
                location.reload();
            }, 1000);

        } catch (err) {
            document.getElementById('upProgress').style.display = 'none';
            showUpError('Upload gagal: ' + err.message);
        }
    }

    function setProgress(pct, text) {
        document.getElementById('upProgressBar').style.width = pct + '%';
        document.getElementById('upProgressText').textContent = text;
    }

    function showUpError(msg) {
        const el = document.getElementById('upError');
        el.textContent = msg;
        el.style.display = 'block';
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', e => {
            if (e.target === overlay) overlay.classList.remove('active');
        });
    });
</script>
{% endblock %}
